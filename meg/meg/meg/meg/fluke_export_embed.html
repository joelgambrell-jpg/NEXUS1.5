<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fluke Export Embed</title>

<link rel="stylesheet" href="../nexus-core.css" />
<link rel="stylesheet" href="../nexus-core.print.css" media="print" />

<style>
  :root{
    --line: rgba(0,0,0,0.15);
    --muted: rgba(0,0,0,0.70);
    --soft: rgba(0,0,0,0.05);
  }
  *{box-sizing:border-box;}

  html,body{
    margin:0;
    padding:0;
    font-family: Arial, Helvetica, sans-serif;
    background: transparent;
    color:#111;
  }

  .wrap-anywhere,
  a,
  .link,
  td,
  th,
  p,
  div{
    overflow-wrap:anywhere;
    word-break:break-word;
    word-wrap:break-word;
    white-space:normal;
  }

  .wrap{ padding: 10px 6px 12px; }

  .header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }

  .title{
    font-size:15px;
    font-weight:900;
    margin:0;
    letter-spacing:.02em;
  }

  .meta{
    font-size:12px;
    font-weight:800;
    color:var(--muted);
  }

  .pillrow{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin: 8px 0 10px;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    background:var(--soft);
    border:1px solid rgba(0,0,0,0.10);
    font-weight:900;
    font-size:12px;
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
    font-size:13px;
  }
  th,td{
    border:1px solid var(--line);
    padding:8px 8px;
    vertical-align:top;
  }
  th{
    background:rgba(0,0,0,0.05);
    text-align:left;
    font-weight:900;
  }

  .muted{ opacity:.8; }
  .empty{
    padding:12px;
    border:1px dashed rgba(0,0,0,0.22);
    border-radius:12px;
    background:rgba(0,0,0,0.03);
    font-weight:900;
  }

  @media print{
    html,body{ background:#fff !important; }
    table, tr, td, th{
      break-inside:avoid;
      page-break-inside:avoid;
    }
  }
</style>
</head>

<body>
<div class="wrap" id="root">
  <div class="header">
    <div>
      <div class="title">Fluke Connect Megohmmeter Logs (Optional)</div>
      <div class="meta">Storage: <span style="font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;">nexus.meg.fluke.sessions.v1</span></div>
    </div>
  </div>

  <div class="pillrow" id="pillRow" style="display:none;"></div>

  <div id="out" class="empty">No Fluke sessions found.</div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const eq = (qs.get("eq") || "").trim();

  function safeParse(v){
    try{ return JSON.parse(v); }catch(e){ return null; }
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function readSessions(){
    const raw = localStorage.getItem("nexus.meg.fluke.sessions.v1") || "[]";
    const arr = safeParse(raw);
    return Array.isArray(arr) ? arr : [];
  }

  function forEq(all, eqId){
    const eqTrim = String(eqId||"").trim();
    if (!eqTrim) return all;
    return all.filter(s=>{
      if(!s || typeof s !== "object") return false;
      return String(s.equipmentId||"").trim() === eqTrim;
    });
  }

  const all = readSessions();
  const sessions = forEq(all, eq);

  const pillRow = document.getElementById("pillRow");
  if (pillRow){
    pillRow.style.display = "flex";
    pillRow.innerHTML = `
      <span class="pill">Equipment: ${esc(eq || "(all)")}</span>
      <span class="pill">Sessions: ${esc(String(sessions.length))}</span>
    `;
  }

  const out = document.getElementById("out");
  if (!sessions.length){
    if (out){
      out.className = "empty";
      out.innerHTML = "No Fluke sessions found.";
    }
    return;
  }

  function pick(o, keys){
    for (const k of keys){
      const v = o && o[k];
      if (v != null && String(v).trim() !== "") return String(v);
    }
    return "";
  }

  const rowsHtml = sessions.map(s=>{
    const when = pick(s, ["at","date","datetime","timestamp","time"]);
    const label = pick(s, ["label","name","test","title"]);
    const summary = pick(s, ["summary","notes","result","reading","details"]);
    const fileName = pick(s, ["fileName","filename","sourceFile","file"]);

    return `
      <tr>
        <td>${esc(when)}</td>
        <td><b>${esc(label)}</b></td>
        <td>
          ${esc(summary)}
          ${fileName ? `<div class="muted" style="margin-top:6px;"><b>File:</b> ${esc(fileName)}</div>` : ``}
        </td>
      </tr>
    `;
  }).join("");

  const html = `
    <table>
      <thead>
        <tr>
          <th style="width:190px;">Date/Time</th>
          <th style="width:220px;">Label</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>${rowsHtml}</tbody>
    </table>
  `;

  if(out){
    out.className = "";
    out.innerHTML = html;
  }
})();
</script>
</body>
</html>
