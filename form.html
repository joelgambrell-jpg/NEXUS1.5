<!-- form.html (FULL DROP-IN REPLACEMENT)
CHANGES (ADDED ONLY — nothing removed):
1) Adds Fluke Connect Import (Optional) button that shows ONLY when id is a Meg page (meg / megohmmeter_line / megohmmeter_load)
2) Adds a "guard" that REMOVES/HIDES any injected "Megohmmeter SOP" buttons from app.js on pages where it should NOT appear
   - Megohmmeter SOP should appear ONLY on Meg pages
   - It will NOT appear on RIF, L2, Torque, Pre-FOD, Diagram Image, Supporting Documents, etc.
3) Keeps Snap-on ConnecTorq Import (Optional) ONLY on Torque page (as you already had)
-->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="nexus-core.css" />
  <link rel="stylesheet" href="nexus-core.print.css" media="print" />
<title>Form</title>

<style>
body{
  margin:0;
  padding:0;
  font-family:Arial, sans-serif;
  color:#fff;
  background:#b60000;
  background-image:url("transformer.jpg");
  background-repeat:no-repeat;
  background-position:center center;
  background-size:cover;
  background-attachment:fixed;
}
.container{
  max-width:900px;
  margin:40px auto;
  background:rgba(255,255,255,0.20);
  padding:30px;
  border-radius:18px;
  backdrop-filter:blur(6px);
  text-align:center;
}
.back{
  color:#fff;
  text-decoration:none;
  font-weight:bold;
  display:inline-block;
  margin-bottom:20px;
}
h1{font-size:32px;font-weight:700;margin-top:0;}
.section-title{
  font-size:22px;
  font-weight:bold;
  margin:20px 0 8px;
  border-bottom:2px solid #fff;
  padding-bottom:6px;
}
.eq-label{font-weight:900;margin:10px 0 18px;font-size:18px;}

.button-panel{
  display:inline-block;
  background: rgba(80, 80, 80, 0.65);
  padding: 34px 54px;
  border-radius: 24px;
  backdrop-filter: blur(4px);
}
.btn{
  display:block;
  margin:18px auto;
  padding:16px 50px;
  font-size:22px;
  font-weight:700;
  border-radius:999px;
  text-decoration:none;
  color:#3ecbff;
  background:#0a0f24;
  border:2px solid #00c2ff;
  cursor:pointer;
}
.btn:hover{transform:translateY(-2px);}
.btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;}
.btn.complete{
  background:#00ff66 !important;
  color:#002b14 !important;
  border-color:#00ff66 !important;
  box-shadow:0 0 14px rgba(0,255,102,.85);
}

/* Prevent blank/injected buttons from showing */
.btn:empty{ display:none !important; }
a.btn:empty{ display:none !important; }
button.btn:empty{ display:none !important; }

/* NOTE: left in place even though bottom media is removed (harmless) */
.media{margin-top:20px;}
.embed{width:100%;height:75vh;border:none;border-radius:12px;background:#111;}

.nx-header-wrap{background: rgba(0,0,0,0.35);border-bottom: 1px solid rgba(255,255,255,0.18);backdrop-filter: blur(8px);}
.nx-header{max-width: 1100px;margin: 0 auto;padding: 14px 18px;display: flex;align-items: center;}
.nx-header img{height: 54px;width: auto;max-width: 100%;object-fit: contain;}

.nx-footer{
  margin-top: 40px;
  padding: 18px 12px;
  text-align: center;
  font-size: 12px;
  font-weight: 700;
  color: rgba(255,255,255,0.85);
  background: rgba(0,0,0,0.35);
  border-top: 1px solid rgba(255,255,255,0.18);
}

#stepCompleteBtn{ display:none; }
/* hidden by default; shown only when id=rif */
#rifNoProcoreBtn{ display:none; }

/* ===== SOP button behavior =====
   Hidden by default; shown ONLY when id is a Meg page.
*/
#openSopBtn{ display:none; }

/* ===== Snap-on (Optional) button behavior =====
   Hidden by default; shown only when id=torque.
*/
#snaponImportBtn{ display:none; }

/* ===== Fluke Connect (Optional) button behavior =====
   Hidden by default; shown only when id is a Meg page.
*/
#flukeImportBtn{ display:none; }

/* Equipment image */
#nexusEquipImageContainer{ text-align:center; margin: 10px 0 18px 0; }
#nexusEquipImageDisplay{
  display:none;
  max-width:100%;
  max-height:320px;
  border-radius:12px;
  box-shadow:0 10px 22px rgba(0,0,0,.28);
  cursor: zoom-in;
}

/* ===== Zoom / Lightbox ===== */
#nxImgModal{
  display:none;
  position:fixed;
  inset:0;
  z-index:99999;
  background:rgba(0,0,0,0.78);
  backdrop-filter: blur(6px);
}
#nxImgModalInner{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
}
#nxImgModalImg{
  max-width:95vw;
  max-height:88vh;
  border-radius:14px;
  box-shadow:0 14px 40px rgba(0,0,0,.55);
  transform: translate3d(0,0,0) scale(1);
  transform-origin: center center;
  touch-action: pan-x pan-y;
  user-select:none;
}
#nxImgModalBar{
  position:absolute;
  top:12px;
  left:12px;
  right:12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  pointer-events:none;
}
.nxImgModalBtn{
  pointer-events:auto;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:10px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.22);
  background: rgba(20,20,20,0.55);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
.nxImgModalHint{
  pointer-events:none;
  opacity:.85;
  font-weight:900;
  font-size:12px;
  background: rgba(20,20,20,0.40);
  border:1px solid rgba(255,255,255,0.14);
  padding:10px 12px;
  border-radius:999px;
  text-align:center;
}
</style>

<link rel="stylesheet" href="assets/css/nexus-core.css">
</head>

<body>
  <div class="nexus-page">

<div id="nxSessionBanner" class="nx-session-banner">
  <div class="nx-left">
    <span class="nx-pill">Equipment: <span data-nx-eq>(none)</span></span>
    <span class="nx-pill">Role: <span data-nx-role>viewer</span></span>
    <span class="nx-pill" data-nx-status>Ready</span>
  </div>
  <div class="nx-right">
    <label style="font-weight:800;font-size:12px;opacity:.95;">Set Role
      <select id="nxRoleSelect" onchange="NEXUS.setRole(this.value)">
        <option value="viewer">viewer</option>
        <option value="tech">tech</option>
        <option value="foreman">foreman</option>
        <option value="superintendent">superintendent</option>
        <option value="admin">admin</option>
      </select>
    </label>
  </div>
</div>

<script>
(function(){
  try{
    var sel=document.getElementById("nxRoleSelect");
    if(sel && window.NEXUS && typeof window.NEXUS.getRole==="function"){
      sel.value = window.NEXUS.getRole();
    }
  }catch(e){}
})();
</script>

<a class="nx-back-btn" href="#" onclick="return NEXUS_back();">← Back</a>

<div class="nx-header-wrap">
  <div class="nx-header">
    <img src="nexus.png" alt="NEXUS" />
  </div>
</div>

<div class="container">
  <a class="back" id="backLink" href="index.html">← Back</a>

  <h1 id="page-title">Loading…</h1>
  <div id="eqLabel" class="eq-label"></div>
  <div class="section-title" id="section-title"></div>

  <!-- Equipment Image Display -->
  <div id="nexusEquipImageContainer">
    <img id="nexusEquipImageDisplay" alt="Equipment image" />
  </div>

  <div id="buttonsWrap" class="button-panel">
    <div id="buttons"></div>

    <!-- #3: Procore (RIF only) -->
    <a class="btn" id="rifNoProcoreBtn" href="rif_no_procore.html">RIF — No Procore</a>

    <!-- SOP (Meg only) -->
    <button class="btn" id="openSopBtn" type="button">Megohmmeter SOP</button>

    <!-- Fluke Connect Import (Meg only, Optional) -->
    <a class="btn" id="flukeImportBtn" href="#">Fluke Connect Import (Optional)</a>

    <!-- Snap-on ConnecTorq Import (Torque only, Optional) -->
    <a class="btn" id="snaponImportBtn" href="#">Snap-on ConnecTorq Import (Optional)</a>

    <!-- #5: Leave alone -->
    <button class="btn" id="stepCompleteBtn" type="button">Mark Step Complete</button>
  </div>

  <!-- Bottom/embedded media removed -->
  <!-- <div id="media" class="media" style="display:none;"></div> -->
</div>

<!-- ===== Zoom Modal Markup ===== -->
<div id="nxImgModal" aria-hidden="true">
  <div id="nxImgModalBar">
    <button class="nxImgModalBtn" id="nxImgModalCloseBtn" type="button">Close</button>
    <div class="nxImgModalHint">Scroll / pinch to zoom • Drag to pan</div>
    <button class="nxImgModalBtn" id="nxImgModalResetBtn" type="button">Reset</button>
  </div>
  <div id="nxImgModalInner">
    <img id="nxImgModalImg" alt="Zoomed image" />
  </div>
</div>

<script src="config.js"></script>
<script src="app.js"></script>

<script>
(function () {
  const qs = new URLSearchParams(location.search);
  const eq = (qs.get("eq") || "").trim();
  const id = (qs.get("id") || "").trim();
  const rif = (qs.get("rif") || "").trim();

  const megIds = new Set(["meg","megohmmeter_line","megohmmeter_load"]);

  const backLink = document.getElementById("backLink");
  if (backLink){
    backLink.href = eq ? `equipment.html?eq=${encodeURIComponent(eq)}` : "index.html";
    backLink.textContent = eq ? "← Back to Equipment" : "← Back to Home";
  }

  const label = document.getElementById("eqLabel");
  if (label) label.textContent = eq ? `Equipment: ${eq}` : "";

  /* ===== SOP BUTTON (Meg only) ===== */
  (function(){
    const sopBtn = document.getElementById("openSopBtn");
    if (!sopBtn) return;

    // Hide by default for all pages
    sopBtn.style.display = "none";
    sopBtn.onclick = null;

    // Show only on Meg pages
    if (megIds.has(id)){
      sopBtn.style.display = "block";
      sopBtn.textContent = "Megohmmeter SOP";
      sopBtn.addEventListener("click", function(){
        const url = `megohmmeter_sop.html${eq ? `?eq=${encodeURIComponent(eq)}` : ""}`;
        location.href = url;
      });
    }
  })();

  /* ===== Fluke Connect Import Button (Meg only, Optional) ===== */
  (function(){
    const flukeBtn = document.getElementById("flukeImportBtn");
    if (!flukeBtn) return;

    flukeBtn.style.display = "none";
    flukeBtn.onclick = null;

    if (!megIds.has(id)) return;

    const href = `meg/fluke_import.html${eq ? `?eq=${encodeURIComponent(eq)}` : ""}`;
    flukeBtn.style.display = "block";
    flukeBtn.textContent = "Fluke Connect Import (Optional)";
    flukeBtn.setAttribute("href", href);
    flukeBtn.removeAttribute("target");
    flukeBtn.removeAttribute("rel");
  })();

  /* ===== Snap-on ConnecTorq Import Button (Torque only, Optional) ===== */
  (function(){
    const snaponBtn = document.getElementById("snaponImportBtn");
    if (!snaponBtn) return;

    // Hidden by default (CSS + here)
    snaponBtn.style.display = "none";
    snaponBtn.onclick = null;

    // Show ONLY on Torque page
    if (id !== "torque") return;

    // Set link to importer (already created in /torque/)
    // Pass eq if present (importer reads ?eq=)
    const href = `torque/snapon_import.html${eq ? `?eq=${encodeURIComponent(eq)}` : ""}`;

    snaponBtn.style.display = "block";
    snaponBtn.setAttribute("href", href);

    // Keep it same-tab (field flow). Prevent external/new tab behavior.
    snaponBtn.removeAttribute("target");
    snaponBtn.removeAttribute("rel");
  })();

  // (3) ONLY repurpose #rifNoProcoreBtn to Procore
  (function(){
    const btn = document.getElementById("rifNoProcoreBtn");
    if(!btn) return;

    if (id !== "rif"){
      btn.style.display = "none";
      return;
    }

    function looksLikeUrl(v){
      return typeof v === "string" && /^https?:\/\//i.test((v||"").trim());
    }

    function deepFindProcore(obj){
      try{
        if (!obj || typeof obj !== "object") return "";
        for (const k in obj){
          const v = obj[k];
          if (typeof v === "string" && looksLikeUrl(v) && (/procore/i.test(k) || /procore/i.test(v))) return v.trim();
          if (v && typeof v === "object"){
            const found = deepFindProcore(v);
            if (found) return found;
          }
        }
      }catch(e){}
      return "";
    }

    function getProcoreUrl(){
      // 1) if Setup forwards it
      const qp = (qs.get("procore") || "").trim();
      if (looksLikeUrl(qp)) return qp;

      // 2) common global keys
      const keys = [
        "nexus_procore_url",
        "nx_procore_url",
        "procore_url",
        "procoreUrl",
        "procore"
      ];
      for (const k of keys){
        const v = (localStorage.getItem(k) || "").trim();
        if (looksLikeUrl(v)) return v;
      }

      // 3) equipment record
      if (eq){
        const raw = localStorage.getItem(`nexus_equipment_${eq}`);
        if (raw){
          try{
            const rec = JSON.parse(raw);
            const direct = (rec.procore || rec.procoreUrl || rec.procore_url || "").toString().trim();
            if (looksLikeUrl(direct)) return direct;
            const found = deepFindProcore(rec);
            if (looksLikeUrl(found)) return found;
          }catch(e){}
        }
      }

      return "";
    }

    const procoreUrl = getProcoreUrl();

    btn.style.display = "block";
    btn.textContent = "RIF — Procore";

    if (!procoreUrl){
      btn.href = "#";
      btn.removeAttribute("target");
      btn.removeAttribute("rel");
      btn.onclick = function(e){
        e.preventDefault();
        alert("Procore link not set in Setup yet.");
        return false;
      };
      return;
    }

    btn.href = procoreUrl;
    btn.target = "_blank";
    btn.rel = "noopener";
    btn.onclick = null;
  })();

  function patchLinks(){
    document.querySelectorAll('a[href]').forEach(a => {
      try{
        const href = a.getAttribute("href");
        if (!href) return;

        const url = new URL(href, location.href);
        if (url.origin !== location.origin) return;

        if (eq) url.searchParams.set("eq", eq);
        if (rif) url.searchParams.set("rif", rif);

        a.setAttribute("href", url.pathname + url.search + url.hash);
      }catch(e){}
    });
  }

  /* ===== GUARD: Remove any injected "Megohmmeter SOP" buttons from app.js on non-meg pages ===== */
  function isMegSopText(txt){
    const t = String(txt||"").trim().toLowerCase();
    if (!t) return false;
    // catch common variants
    return t === "megohmmeter sop" || t.indexOf("megohmmeter sop") !== -1;
  }

  function enforceMegSopVisibility(){
    try{
      const allow = megIds.has(id);

      // Look only inside the dynamic buttons region + panel (where app.js injects)
      const scope = document.getElementById("buttonsWrap") || document.body;
      const candidates = scope.querySelectorAll("a.btn,button.btn");

      candidates.forEach(el => {
        // Never touch our dedicated SOP button by id — we control it above.
        if (el.id === "openSopBtn") return;

        // If app.js injected a Meg SOP link/button, remove/hide it unless we're on a Meg page.
        const text = (el.textContent || "").replace(/\s+/g," ").trim();
        if (!isMegSopText(text)) return;

        if (!allow){
          el.style.display = "none";
          el.style.pointerEvents = "none";
          el.setAttribute("aria-hidden","true");
        }else{
          // On Meg pages, we still prefer ONLY the dedicated SOP button (so hide duplicates)
          el.style.display = "none";
          el.style.pointerEvents = "none";
          el.setAttribute("aria-hidden","true");
        }
      });
    }catch(e){}
  }

  patchLinks();
  enforceMegSopVisibility();

  const observer = new MutationObserver(() => {
    patchLinks();
    enforceMegSopVisibility();
  });

  observer.observe(document.getElementById("buttons") || document.body, { childList:true, subtree:true });
})();
</script>

<!-- Equipment image loader (ONLY show on id=transformer) + Zoom Modal behavior -->
<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const eq = (qs.get("eq") || "").trim();
  const id = (qs.get("id") || "").trim();

  const container = document.getElementById("nexusEquipImageContainer");
  const img = document.getElementById("nexusEquipImageDisplay");
  if (!container || !img) return;

  // ONLY show the equipment image on the Diagram Image page
  if (id !== "transformer"){
    container.style.display = "none";
    return;
  }

  function readLocalRecord(){
    try{ return JSON.parse(localStorage.getItem(`nexus_equipment_${eq}`) || "{}"); }
    catch(e){ return {}; }
  }

  function show(url){
    if(!url) return;
    img.src = url;
    img.style.display = "block";
  }

  if(eq){
    const rec = readLocalRecord();
    if(rec.imageDataUrl) show(rec.imageDataUrl);
  }

  // Firebase-ready hook
  window.NEXUS_setEquipmentImageUrl = function(url){
    show(url);
  };

  // ===== Zoom / Lightbox =====
  const modal = document.getElementById("nxImgModal");
  const modalImg = document.getElementById("nxImgModalImg");
  const closeBtn = document.getElementById("nxImgModalCloseBtn");
  const resetBtn = document.getElementById("nxImgModalResetBtn");

  if (!modal || !modalImg || !closeBtn || !resetBtn) return;

  let scale = 1;
  let panX = 0;
  let panY = 0;
  let dragging = false;
  let startX = 0;
  let startY = 0;

  function applyTransform(){
    modalImg.style.transform = `translate3d(${panX}px, ${panY}px, 0) scale(${scale})`;
  }
  function resetTransform(){
    scale = 1; panX = 0; panY = 0;
    applyTransform();
  }
  function openModal(){
    if (!img.src) return;
    modalImg.src = img.src;
    modal.style.display = "block";
    modal.setAttribute("aria-hidden","false");
    resetTransform();
    document.body.style.overflow = "hidden";
  }
  function closeModal(){
    modal.style.display = "none";
    modal.setAttribute("aria-hidden","true");
    modalImg.removeAttribute("src");
    document.body.style.overflow = "";
  }

  img.addEventListener("click", openModal);

  closeBtn.addEventListener("click", closeModal);
  resetBtn.addEventListener("click", resetTransform);

  // click outside image closes
  modal.addEventListener("click", (e) => {
    if (e.target === modal || e.target === document.getElementById("nxImgModalInner")) closeModal();
  });

  // ESC closes
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modal.style.display === "block") closeModal();
  });

  // Mouse wheel zoom (desktop)
  modal.addEventListener("wheel", (e) => {
    if (modal.style.display !== "block") return;
    e.preventDefault();
    const delta = Math.sign(e.deltaY);
    const next = scale * (delta > 0 ? 0.9 : 1.1);
    scale = Math.max(1, Math.min(6, next));
    applyTransform();
  }, { passive:false });

  // Drag to pan (desktop + mobile single-finger)
  modalImg.addEventListener("pointerdown", (e) => {
    dragging = true;
    startX = e.clientX - panX;
    startY = e.clientY - panY;
    modalImg.setPointerCapture(e.pointerId);
  });
  modalImg.addEventListener("pointermove", (e) => {
    if (!dragging) return;
    panX = e.clientX - startX;
    panY = e.clientY - startY;
    applyTransform();
  });
  modalImg.addEventListener("pointerup", () => { dragging = false; });
  modalImg.addEventListener("pointercancel", () => { dragging = false; });
})();
</script>

<script>
(function(){
  window.NEXUS_back = function(){
    const qs = new URLSearchParams(location.search);
    const eq = qs.get("eq");
    location.href = eq ? `equipment.html?eq=${encodeURIComponent(eq)}` : "equipment.html";
    return false;
  };
})();
</script>

<footer class="nx-footer">
  © 2026 NEXUS Data Science — Built for ACE Electric — All Rights Reserved
</footer>

<script src="assets/js/nexus-core.js"></script>
<script src="assets/js/nexus-firebase-bridge.js"></script>
<script>
/* Hide any blank pill/button that gets injected (covers whitespace, nbsp, etc.) */
(function(){
  function isTrulyBlankButton(el){
    if (!el) return false;

    const isButtonish =
      el.matches('a,button,div,span') &&
      (
        el.classList.contains('btn') ||
        el.getAttribute('role') === 'button' ||
        el.tagName === 'BUTTON'
      );

    if (!isButtonish) return false;
    if (el.querySelector('img,svg,canvas,video')) return false;

    const aria = (el.getAttribute('aria-label') || '').trim();
    const title = (el.getAttribute('title') || '').trim();
    if (aria || title) return false;

    const text = (el.textContent || '')
      .replace(/\u00A0/g, ' ')
      .replace(/\u200B/g, '')
      .trim();

    return text.length === 0;
  }

  function hideBlanks(root){
    const scope = root || document;
    const candidates = scope.querySelectorAll('a,button,div,span');
    candidates.forEach(el => {
      if (isTrulyBlankButton(el)){
        el.style.display = 'none';
        el.style.pointerEvents = 'none';
      }
    });
  }

  hideBlanks(document);

  const obs = new MutationObserver((mutations) => {
    for (const m of mutations){
      m.addedNodes && m.addedNodes.forEach(n => {
        if (n.nodeType === 1){
          hideBlanks(n);
        }
      });
    }
  });

  obs.observe(document.body, { childList:true, subtree:true });
})();
</script>

  </div>
</body>
</html>
