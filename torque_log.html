<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="nexus-core.css" />
  <link rel="stylesheet" href="nexus-core.print.css" media="print" />
<title>Torque Application Log</title>
<style>
  :root{--bg:#b60000;--panel:rgba(255,255,255,0.20);--line:rgba(255,255,255,0.20);--accent:#00c2ff;--btn-bg:#0a0f24;--btn-txt:#3ecbff;--ok:#00ff66;--bad:#ff3b3b;}
  *{box-sizing:border-box}
  html,body{margin:0;font-family:Arial,Helvetica,sans-serif;color:#fff;background:var(--bg);}
  body{background-image:url("transformer.jpg");background-repeat:no-repeat;background-position:center center;background-size:cover;background-attachment:fixed;}
  .nx-header-wrap{background:rgba(0,0,0,0.35);border-bottom:1px solid rgba(255,255,255,0.18);backdrop-filter:blur(8px)}
  .nx-header{max-width:1100px;margin:0 auto;padding:14px 18px;display:flex;align-items:center}
  .nx-header img{height:54px;width:auto;object-fit:contain}
  .container{max-width:1000px;margin:24px auto 60px;background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:22px;backdrop-filter:blur(6px)}
  .top{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start}
  h1{margin:0;font-size:28px;font-weight:900}
  .meta{font-weight:900;opacity:.95}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .btn{padding:12px 16px;font-size:14px;font-weight:900;border-radius:999px;color:var(--btn-txt);background:var(--btn-bg);border:2px solid var(--accent);cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;user-select:none}
  .btn.secondary{background:rgba(0,0,0,0.20);color:#fff;border:2px solid rgba(255,255,255,0.35)}
  .btn.complete{background:#00ff66 !important;color:#002b14 !important;border-color:#00ff66 !important;box-shadow:0 0 14px rgba(0,255,102,.85)}
  .section{margin-top:18px;padding:16px;border-radius:18px;background:rgba(0,0,0,0.22);border:1px solid rgba(255,255,255,0.20)}
  .section-title{margin:0 0 12px;font-weight:900;letter-spacing:.02em}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th{font-size:12px;letter-spacing:.12em;text-transform:uppercase;opacity:.95;text-align:left;padding:0 8px}
  td{padding:0 8px}
  input,select,textarea{width:100%;padding:10px 10px;border-radius:12px;border:1px solid rgba(255,255,255,0.18);outline:none;font-size:14px;background:rgba(255,255,255,0.92);color:#111;font-weight:800}
  textarea{min-height:44px;resize:vertical}
  .row-actions{display:flex;gap:8px;justify-content:flex-end}
  .mini{padding:9px 12px;font-size:13px}
  .go-wrap{display:flex;gap:10px;align-items:center}
  .pill{flex:1;display:inline-flex;align-items:center;justify-content:center;height:38px;border-radius:999px;font-weight:900;border:2px solid rgba(255,255,255,0.25);cursor:pointer;user-select:none;transition:.12s}
  .pill.go{background:rgba(0,255,102,0.18);border-color:rgba(0,255,102,0.55);color:#eafff1}
  .pill.nogo{background:rgba(255,59,59,0.18);border-color:rgba(255,59,59,0.55);color:#ffecec}
  .pill.on.go{background:var(--ok);border-color:var(--ok);color:#002b14;box-shadow:0 0 14px rgba(0,255,102,.75)}
  .pill.on.nogo{background:var(--bad);border-color:var(--bad);color:#240000;box-shadow:0 0 14px rgba(255,59,59,.75)}
  .hint{opacity:.9;font-weight:800;font-size:13px;line-height:1.35;margin-top:8px}
  @media (max-width:760px){.top{flex-direction:column;align-items:stretch}}

#stepCompleteBtn{display:none !important;}
</style>

<style>
  .nx-footer{
    margin-top: 40px;
    padding: 18px 12px;
    text-align: center;
    font-size: 12px;
    font-weight: 700;
    color: rgba(255,255,255,0.85);
    background: rgba(0,0,0,0.35);
    border-top: 1px solid rgba(255,255,255,0.18);
  }
</style>

  <link rel="stylesheet" href="assets/css/nexus-core.css">
</head>
<body>
  <div class="nexus-page">\n
<div id="nxSessionBanner" class="nx-session-banner">
  <div class="nx-left">
    <span class="nx-pill">Equipment: <span data-nx-eq>(none)</span></span>
    <span class="nx-pill">Role: <span data-nx-role>viewer</span></span>
    <span class="nx-pill" data-nx-status>Ready</span>
  </div>
  <div class="nx-right">
    <label style="font-weight:800;font-size:12px;opacity:.95;">Set Role
      <select id="nxRoleSelect" onchange="NEXUS.setRole(this.value)">
        <option value="viewer">viewer</option>
        <option value="tech">tech</option>
        <option value="foreman">foreman</option>
        <option value="superintendent">superintendent</option>
        <option value="admin">admin</option>
      </select>
    </label>
  </div>
</div>
<script>
  (function(){
    try{
      var sel=document.getElementById("nxRoleSelect");
      if(sel && window.NEXUS && typeof window.NEXUS.getRole==="function"){
        sel.value = window.NEXUS.getRole();
      }
    }catch(e){}
  })();
</script>

<a class="nx-back-btn" href="#" onclick="return NEXUS_back();">← Back</a>

<div class="nx-header-wrap"><div class="nx-header"><img src="nexus.png" alt="NEXUS" /></div></div>
<div class="container">
  <div class="top">
    <div>
      <h1>Torque Application Log</h1>
      <div class="meta" id="eqLabel"></div>
    </div>
    <div>
      <div class="actions">
        <a class="btn secondary" id="backBtn" href="#" onclick="return NEXUS_back();">Back</a>
        <button class="btn secondary" id="saveBtn" type="button">Save</button>
        <button class="btn" id="exportEmailBtn" type="button">Export to Email</button>
        <button class="btn" id="stepCompleteBtn" type="button">STEP COMPLETE</button>
      </div>
      <div class="hint">Save persists locally now and includes Firebase hook placeholders. Export opens an email draft (PDF export should be generated server-side in Firebase later).</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Torque Notes &amp; Units</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div>
        <label style="font-weight:900">Units</label>
        <select id="notesUnit">
          <option value="ft-lbs">ft-lbs</option>
          <option value="in-lbs">in-lbs</option>
        </select>
      </div>
      <div>
        <label style="font-weight:900">Torque Value</label>
        <input id="notesTorque" type="number" step="any" placeholder="Enter torque value" />
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Torque Application Entries</div>
    <div class="row-actions" style="margin-bottom:10px">
      <button class="btn secondary mini" type="button" id="addRowBtn">Add Row</button>
      <button class="btn secondary mini" type="button" id="clearRowsBtn">Clear</button>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:14%">Date</th>
          <th style="width:14%">Time</th>
          <th style="width:18%">Location</th>
          <th style="width:18%">Bolt Size</th>
          <th style="width:12%">Unit</th>
          <th style="width:12%">Value</th>
          <th style="width:12%">Notes</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div class="section">
    <div class="section-title">Tilt Test (Go / No Go)</div>
    <div class="hint">Select Go or No Go for each required check. Date/Technician tracked elsewhere.</div>

    <table>
      <thead>
        <tr>
          <th style="width:32%">Pre Torque Tilt Test</th>
          <th style="width:22%">A-B</th>
          <th style="width:22%">A-C</th>
          <th style="width:22%">B-C</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="font-weight:900">Phase to Phase</td>
          <td data-tilt="AB"></td>
          <td data-tilt="AC"></td>
          <td data-tilt="BC"></td>
        </tr>
      </tbody>
    </table>

    <div style="height:10px"></div>

    <table>
      <thead>
        <tr>
          <th style="width:32%"></th>
          <th style="width:22%">A-G</th>
          <th style="width:22%">B-G</th>
          <th style="width:22%">C-G</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="font-weight:900">Phase to Ground</td>
          <td data-tilt="AG"></td>
          <td data-tilt="BG"></td>
          <td data-tilt="CG"></td>
        </tr>
      </tbody>
    </table>

    <div style="height:10px"></div>

    <table>
      <thead>
        <tr>
          <th style="width:32%"></th>
          <th style="width:22%">A-N</th>
          <th style="width:22%">B-N</th>
          <th style="width:22%">C-N</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="font-weight:900">Phase to Neutral</td>
          <td data-tilt="AN"></td>
          <td data-tilt="BN"></td>
          <td data-tilt="CN"></td>
        </tr>
      </tbody>
    </table>

    <div style="height:10px"></div>

    <table>
      <thead>
        <tr>
          <th style="width:32%"></th>
          <th style="width:68%">N-G</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="font-weight:900">Neutral to Ground</td>
          <td data-tilt="NG"></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
</div>

<script>
(function(){
  const qs=new URLSearchParams(location.search);
  const eq=(qs.get("eq")||"").trim();
  const stepId="torque";

  const eqLabel=document.getElementById("eqLabel");
  eqLabel.textContent=eq?`Equipment: ${eq}`:"Missing equipment ID (eq)";

  const backBtn=document.getElementById("backBtn");
  backBtn.textContent="Back to Equipment";
const stepBtn=document.getElementById("stepCompleteBtn");
  if(stepBtn){ stepBtn.style.display="none"; }

  function stepKey(id){return `nexus_${eq||"NO_EQ"}_step_${id}`;}
  function done(){return !!(eq && localStorage.getItem(stepKey(stepId))==="1");}
  function refreshStep(){
    stepBtn.classList.toggle("complete", done());
    stepBtn.disabled=!eq;
    stepBtn.title=eq?"":"Missing eq";
  }
  stepBtn.addEventListener("click",()=>{
    if(!eq) return;
    const next=!done();
    if(next) localStorage.setItem(stepKey(stepId),"1");
    else localStorage.removeItem(stepKey(stepId));
    refreshStep();
  });

  function dataKey(){return `nexus_${eq||"NO_EQ"}_torque_log_v1`;}

  const boltSizes=[
    '1/4" slotted','1/4"','5/16"','3/8"','7/16"','1/2"','9/16"','5/8"','3/4"','7/8"','1"',
    'M6','M8','M10','M12','M16'
  ];

  const rowsEl=document.getElementById("rows");
  const addRowBtn=document.getElementById("addRowBtn");
  const clearRowsBtn=document.getElementById("clearRowsBtn");

  function mkRow(r={}){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input type="date" value="${r.date||""}"></td>
      <td><input type="time" value="${r.time||""}"></td>
      <td><input type="text" placeholder="Panel / Room" value="${(r.location||"").replace(/"/g,'&quot;')}"></td>
      <td>
        <select>
          ${boltSizes.map(s=>`<option ${s===r.bolt?"selected":""} value="${s.replace(/"/g,'&quot;')}">${s}</option>`).join('')}
          <option value="__custom__">Custom…</option>
        </select>
      </td>
      <td>
        <select>
          <option value="ft-lbs" ${r.unit==="ft-lbs"?"selected":""}>ft-lbs</option>
          <option value="in-lbs" ${r.unit==="in-lbs"?"selected":""}>in-lbs</option>
        </select>
      </td>
      <td><input type="number" step="any" value="${r.value||""}"></td>
      <td><input type="text" placeholder="Notes" value="${(r.notes||"").replace(/"/g,'&quot;')}"></td>
    `;

    const sel=tr.children[3].querySelector('select');
    sel.addEventListener('change',()=>{
      if(sel.value==='__custom__'){
        const v=prompt('Enter bolt size label (e.g., 1/4" slotted)');
        if(v){
          const opt=document.createElement('option');
          opt.value=v; opt.textContent=v;
          sel.insertBefore(opt, sel.lastElementChild);
          sel.value=v;
        } else {
          sel.value=boltSizes[0];
        }
      }
    });

    return tr;
  }

  function readRows(){
    const out=[];
    rowsEl.querySelectorAll('tr').forEach(tr=>{
      const tds=[...tr.querySelectorAll('td')];
      out.push({
        date: tds[0].querySelector('input').value,
        time: tds[1].querySelector('input').value,
        location: tds[2].querySelector('input').value,
        bolt: tds[3].querySelector('select').value,
        unit: tds[4].querySelector('select').value,
        value: tds[5].querySelector('input').value,
        notes: tds[6].querySelector('input').value,
      });
    });
    return out;
  }

  function setRows(rows){
    rowsEl.innerHTML='';
    (rows||[]).forEach(r=>rowsEl.appendChild(mkRow(r)));
    if(!rows || rows.length===0) rowsEl.appendChild(mkRow({}));
  }

  addRowBtn.addEventListener('click',()=>rowsEl.appendChild(mkRow({}))); 
  clearRowsBtn.addEventListener('click',()=>{ if(confirm('Clear all rows?')) setRows([]); });

  // Tilt test matrix (Go / No Go)
  function tiltKey(){return `nexus_${eq||"NO_EQ"}_torque_tilt_v2`;}

  const TILT_KEYS = ["AB","AC","BC","AG","BG","CG","AN","BN","CN","NG"];

  function mkGoNoGoCell(td, value){
    td.innerHTML = `
      <div class="go-wrap">
        <div class="pill go" data-v="GO">GO</div>
        <div class="pill nogo" data-v="NO_GO">NO GO</div>
      </div>
    `;
    const pills=[...td.querySelectorAll('.pill')];
    function apply(v){
      pills.forEach(p=>p.classList.toggle('on', p.getAttribute('data-v')===v));
      td.setAttribute('data-result', v||'');
    }
    pills.forEach(p=>p.addEventListener('click',()=>apply(p.getAttribute('data-v'))));
    apply(value);
  }

  function setTilt(obj){
    document.querySelectorAll('[data-tilt]').forEach(td=>{
      const k = td.getAttribute('data-tilt');
      mkGoNoGoCell(td, (obj && obj[k]) ? obj[k] : '');
    });
  }

  function readTilt(){
    const out = {};
    document.querySelectorAll('[data-tilt]').forEach(td=>{
      const k = td.getAttribute('data-tilt');
      out[k] = td.getAttribute('data-result') || '';
    });
    return out;
  }
  // Notes section
  const notesUnit=document.getElementById('notesUnit');
  const notesTorque=document.getElementById('notesTorque');

  function saveLocal(){
    const payload={
      meta:{eq, updatedAt: new Date().toISOString()},
      notes:{unit:notesUnit.value, torque:notesTorque.value},
      rows: readRows(),
      tilt: readTilt(),
    };
    localStorage.setItem(dataKey(), JSON.stringify(payload));
    localStorage.setItem(tiltKey(), JSON.stringify(payload.tilt));
    // Firebase hook placeholder:
    // window.nexusFirebase?.saveTorqueLog?.(eq, payload);
  }

  function loadLocal(){
    try{
      const raw=localStorage.getItem(dataKey());
      if(raw){
        const p=JSON.parse(raw);
        notesUnit.value=p?.notes?.unit||'ft-lbs';
        notesTorque.value=p?.notes?.torque||'';
        setRows(p?.rows||[]);
        setTilt(p?.tilt||{});
        return;
      }
    }catch(e){}
    setRows([]);
    setTilt({});
  }

  document.getElementById('saveBtn').addEventListener('click',()=>{saveLocal(); alert('Saved.');});

  document.getElementById('exportEmailBtn').addEventListener('click',()=>{
    saveLocal();
    const subject=`NEXUS Torque Log - ${eq||'NO_EQ'}`;
    const body=`Torque log saved for ${eq||'NO_EQ'} on ${new Date().toLocaleString()}%0D%0A%0D%0A`+
      `Next step: Firebase Cloud Function should generate PDF and attach it to emails / Procore.\n`;
    window.location.href=`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  });

  loadLocal();
  refreshStep();
})();
</script>

<script>
(function(){
  window.NEXUS_back = function(){
    try{
      if (document.referrer && document.referrer.indexOf(location.host) !== -1){
        history.back();
        return false;
      }
    }catch(e){}
    const qs = new URLSearchParams(location.search);
    const eq = qs.get("eq");
    location.href = eq ? `equipment.html?eq=${encodeURIComponent(eq)}` : "equipment.html";
    return false;
  };
})();
</script>


<footer class="nx-footer">
  © 2026 NEXUS Data Science — Built for ACE Electric — All Rights Reserved
</footer>

  <script src="assets/js/nexus-core.js"></script>
  <script src="assets/js/nexus-firebase-bridge.js"></script>
  </div>
</body>
</html>
